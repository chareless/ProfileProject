@model User

@inject IHttpContextAccessor HttpContextAccessor

@{
    var session = HttpContextAccessor.HttpContext.Session;

    var id = session?.GetInt32("UserId");

    ViewBag.Title = "Profile Project";
    ViewBag.BreadcrumbItemActive = Model.NameSurname;
}

<div class="container">
    <div class="card">
        <div id="uploadMessage" class="alert d-none" role="alert"></div>

        <div class="card-body">
            <div class="flex-shrink-0">
                <img src="@(string.IsNullOrEmpty(Model.Picture) ? "/assets/images/no-photo.png" : Model.Picture)"
                     alt="User Picture"
                     width="250px"
                     height="250px"
                     class="user-avtar rounded-circle"
                     id="profilePicture"
                     style="cursor:pointer; object-fit: cover;" />

                <!-- Gizli dosya yükleme input'u -->
                <input type="file" id="fileUpload" style="display:none;" accept="image/*" />
            </div>
            <br />
            <h1>@Model.NameSurname  &nbsp; &nbsp; &nbsp; <a asp-action="Edit" asp-controller="Profile" asp-route-id="@Model.Id"><i class="fa fa-edit"></i></a></h1>
        </div>
        <div class="card-body">
            <h3>@Model.Job</h3>
      </div>
    </div>
    <div class="card">
        <div class="card-body">
            <p>Diğer bilgiler</p>
        </div>
       
    </div>
   
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const profilePicture = document.getElementById("profilePicture");
            const fileUpload = document.getElementById("fileUpload");
            const uploadMessage = document.getElementById("uploadMessage");

            // Resme tıklanınca dosya seçim penceresi açılsın
            profilePicture.addEventListener("click", () => {
                fileUpload.click();
            });

            // Dosya seçildikten sonra upload başlasın
            fileUpload.addEventListener("change", async function () {
                if (fileUpload.files.length > 0) {
                    const formData = new FormData();
                    formData.append("formFile", fileUpload.files[0]);
                    formData.append("UserID", "@Model.Id"); // ViewModel içinde UserID varsa

                    try {
                        const response = await fetch("/Profile/PictureUpload", {
                            method: "POST",
                            body: formData
                        });

                        if (response.ok) {
                            const newFileName = await response.text();

                            // Profil fotoğrafını güncelle
                            profilePicture.src = `/Profiles/@Model.Id/Images/${newFileName}`;

                            // Başarılı mesajı göster
                            uploadMessage.textContent = "Kullanıcı görseli başarılı bir şekilde yüklendi.";
                            uploadMessage.className = "alert alert-success mt-3";
                            uploadMessage.classList.remove("d-none");
                        } else {
                            // Hata mesajı göster
                            uploadMessage.textContent = "Yükleme başarısız.";
                            uploadMessage.className = "alert alert-danger mt-3";
                            uploadMessage.classList.remove("d-none");
                        }
                    } catch (e) {
                        console.error("Upload hatası:", e);
                        uploadMessage.textContent = "Yükleme sırasında bir hata oluştu.";
                        uploadMessage.className = "alert alert-danger mt-3";
                        uploadMessage.classList.remove("d-none");
                    }
                }
            });
        });
    </script>
}
